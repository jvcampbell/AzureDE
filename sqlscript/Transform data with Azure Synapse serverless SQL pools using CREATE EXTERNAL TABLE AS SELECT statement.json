{
	"name": "Transform data with Azure Synapse serverless SQL pools using CREATE EXTERNAL TABLE AS SELECT statement",
	"properties": {
		"folder": {
			"name": "Create metadata objects in Azure Synapse serverless SQL pools"
		},
		"content": {
			"query": "/*\nTransform data with Azure Synapse serverless SQL pools \n    using CREATE EXTERNAL TABLE AS SELECT statement\n*/\n\n--CREATE EXTERNAL TABLE AS SELECT in serverless SQL pool\n\n-- you might need to execute following statement if you never did so on current database\n-- CREATE MASTER KEY\n\nCREATE DATABASE SCOPED CREDENTIAL destination_credential\nWITH IDENTITY='SHARED ACCESS SIGNATURE',  \n\tSECRET = '?sv=2020-02-10&ss=bfqt&srt=sco&sp=rwdlacupx&se=2021-04-16T13:17:37Z&st=2021-04-09T05:17:37Z&spr=https&sig=9ZaVXkPaKOzw7PDjfUhxPZezH%2FmTTEfn%2FzVm8XtxiEw%3D' -- fill in your SAS key that will be used for CETAS destination\nGO\n\nCREATE EXTERNAL DATA SOURCE destination_ds\nWITH\n(    \n\tLOCATION         = 'https://challengedl.dfs.core.windows.net/challenge-fs' -- replace path to match root path for your CETAS destination\n     , CREDENTIAL = destination_credential\n)\nGO\n\nCREATE EXTERNAL FILE FORMAT parquet_file_format\nWITH\n(  \n    FORMAT_TYPE = PARQUET,\n    DATA_COMPRESSION = 'org.apache.hadoop.io.compress.SnappyCodec'\n)\nGO\n\n-- use CETAS to export select statement with OPENROWSET result to  storage\nCREATE EXTERNAL TABLE aggregated_data\nWITH (\n    LOCATION = 'aggregated_data/',\n    DATA_SOURCE = destination_ds,  \n    FILE_FORMAT = parquet_file_format\n)  \nAS\nSELECT decennialTime, stateName, SUM(population) AS population\nFROM\n    OPENROWSET(BULK 'https://azureopendatastorage.blob.core.windows.net/censusdatacontainer/release/us_population_county/year=*/*.parquet',\n    FORMAT='PARQUET') AS [r]\nGROUP BY decennialTime, stateName\nGO\n\n-- you can query the newly created external table\nSELECT * FROM aggregated_data",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"poolName": "Built-in",
				"databaseName": "30daychallenge_serverlessSQL"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}